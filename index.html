<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>MedMastery ‚Ä¢ Course Hub</title>

  <style>
    /* RESET & VARS (Apple-glass style) */
    :root{
      --bg-body:#fbfbfd;
      --glass: rgba(255,255,255,0.68);
      --glass-border: rgba(255,255,255,0.50);
      --glass-shadow: 0 14px 40px rgba(0,0,0,0.06);

      --primary:#0071e3;
      --primary-2:#4facfe;
      --primary-grad: linear-gradient(135deg, var(--primary), var(--primary-2));

      --text-main:#1d1d1f;
      --text-sec:#86868b;

      --danger:#ff3b30;
      --success:#34c759;
      --radius-l: 28px;
      --radius-m: 18px;
      --radius-s: 12px;

      --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
    html,body{height:100%;width:100%;margin:0;padding:0;font-family:var(--font);color:var(--text-main);overflow:hidden;background:var(--bg-body);}

    /* Ambient background */
    .ambient-bg{
      position:absolute; inset:-50%; width:200%; height:200%;
      background:
        radial-gradient(circle at 50% 50%, rgba(0,113,227,0.08), transparent 40%),
        radial-gradient(circle at 20% 80%, rgba(52,199,89,0.07), transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(175,82,222,0.07), transparent 40%);
      animation: moveBg 20s infinite alternate ease-in-out;
      z-index:-1;
      pointer-events:none;
      filter:saturate(115%);
    }
    @keyframes moveBg{
      0%{transform:translate(0,0) scale(1)}
      100%{transform:translate(-5%,-5%) scale(1.05)}
    }

    /* Shell */
    .app-shell{
      display:flex;
      flex-direction:column;
      height:100%;
      max-width:1200px;
      margin:0 auto;
      position:relative;
    }

    /* Glass panels */
    .glass-panel{
      background:var(--glass);
      backdrop-filter:saturate(180%) blur(24px);
      -webkit-backdrop-filter:saturate(180%) blur(24px);
      border:1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }

    header{
      padding:20px 24px;
      display:flex; align-items:center; justify-content:space-between;
      z-index:100;
    }
    .logo-area{display:flex; align-items:center; gap:12px;}
    .logo-icon{
      width:40px;height:40px;border-radius:12px;
      background: var(--primary-grad);
      color:white;font-weight:900;font-size:1.15rem;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 12px rgba(0,113,227,0.25);
    }
    .app-name{font-weight:800;font-size:1.08rem; letter-spacing:-0.02em;}
    .nav-actions{display:flex;gap:12px; align-items:center;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
      color: var(--text-sec);
      font-weight:800;
      font-size:0.82rem;
    }

    .btn-icon{
      width:40px;height:40px;border-radius:50%;
      border:none;
      background:rgba(0,0,0,0.04);
      color:var(--text-main);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:transform .2s var(--ease), background .2s var(--ease);
      user-select:none;
      font-size:1.05rem;
    }
    .btn-icon:hover{background:rgba(0,0,0,0.08);transform:scale(1.05)}
    .btn-icon:active{transform:scale(0.97)}

    /* Views */
    .view-container{flex:1; position:relative; overflow:hidden;}
    .view{
      position:absolute; inset:0;
      padding:20px 24px 110px 24px;
      overflow-y:auto; overflow-x:hidden;
      opacity:0; pointer-events:none;
      transform: translateY(18px) scale(0.985);
      transition: opacity .42s var(--ease), transform .42s var(--ease);
      display:flex; flex-direction:column; gap:24px;
    }
    .view.active{
      opacity:1; pointer-events:auto;
      transform: translateY(0) scale(1);
      z-index:10;
    }

    /* Titles */
    .section-header{margin-bottom:2px;}
    .h2-title{font-size:2rem;font-weight:800;margin:0;letter-spacing:-0.02em;}
    .h-sub{color:var(--text-sec);font-size:1rem;margin-top:6px;line-height:1.45;}

    /* Buttons */
    .btn-primary{
      width:100%;
      padding:16px;
      border-radius:999px;
      border:none;
      background: var(--text-main);
      color:white;
      font-size:1rem;
      font-weight:800;
      cursor:pointer;
      transition:transform .2s var(--ease), box-shadow .2s var(--ease), opacity .2s var(--ease);
      user-select:none;
    }
    .btn-primary.blue{background: var(--primary);}
    .btn-primary:hover{transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.14);}
    .btn-primary:active{transform: scale(0.985);}
    .btn-primary:disabled{opacity:.45; cursor:not-allowed; transform:none; box-shadow:none;}
    .btn-secondary{
      width:100%;
      padding:14px 16px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.55);
      color: var(--text-main);
      font-weight:800;
      cursor:pointer;
      transition:transform .2s var(--ease), background .2s var(--ease);
    }
    .btn-secondary:hover{transform: translateY(-1px); background: rgba(255,255,255,0.75);}

    /* Inputs */
    .input-group{margin-bottom:14px;}
    .input-label{
      display:block; font-size:.82rem; font-weight:800;
      color: var(--text-sec); margin:0 0 8px 4px;
    }
    .input-field{
      width:100%;
      padding:16px;
      border-radius: var(--radius-m);
      border:1px solid transparent;
      background:#f2f2f7;
      font-size:1rem;
      font-weight:650;
      font-family:inherit;
      transition:all .2s var(--ease);
    }
    .input-field:focus{
      background:white;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0,113,227,0.14);
    }
    .inline-row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .inline-row .input-field{max-width:160px; text-align:center;}

    /* Course grid */
    .grid-courses{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap:20px;
    }
    .course-card{
      border-radius: var(--radius-l);
      padding:24px;
      cursor:pointer;
      transition: all .3s var(--ease);
      display:flex;
      flex-direction:column;
      height:220px;
      justify-content:space-between;
      overflow:hidden;
      position:relative;
    }
    .course-card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(circle at 30% 20%, rgba(0,113,227,0.10), transparent 55%),
        radial-gradient(circle at 80% 90%, rgba(175,82,222,0.08), transparent 60%);
      pointer-events:none;
    }
    .course-card > *{position:relative;}
    .course-card:hover{transform: translateY(-6px); box-shadow: 0 18px 50px rgba(0,0,0,0.08);}
    .course-icon{font-size:3rem; margin-bottom:10px;}
    .course-info h3{margin:0; font-size:1.45rem; font-weight:850; letter-spacing:-0.02em;}
    .course-info p{margin:8px 0 0 0; color: var(--text-sec); font-size:.95rem; line-height:1.4;}
    .course-stats{display:flex; gap:10px; margin-top:auto; flex-wrap:wrap;}
    .badge{
      font-size:0.78rem; font-weight:850; padding:7px 12px; border-radius:999px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.06);
      color: var(--text-sec);
    }

    /* Course view */
    .top-bar{display:flex; align-items:center; gap:12px; margin-bottom:4px;}
    .back-btn{font-weight:800;color: var(--text-sec); cursor:pointer; display:flex; align-items:center; gap:6px; font-size:.95rem; user-select:none;}
    .back-btn:hover{color: var(--primary);}

    .stats-row{display:grid; grid-template-columns: 1fr 1fr; gap:16px;}
    @media (max-width: 720px){
      .stats-row{grid-template-columns:1fr;}
    }
    .stat-card{
      padding:20px; border-radius: var(--radius-m);
      display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
      position:relative; overflow:hidden;
    }
    .stat-card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(circle at 30% 0%, rgba(0,113,227,0.10), transparent 55%);
      pointer-events:none;
    }
    .stat-card > *{position:relative;}
    .stat-val{font-size:2rem; font-weight:900;}
    .stat-label{font-size:.78rem; font-weight:900; color: var(--text-sec); text-transform:uppercase; letter-spacing:.06em;}
    .stat-mini{margin-top:10px; color: var(--text-sec); font-weight:750; font-size:.92rem; line-height:1.35;}

    .panel{
      padding:24px;
      border-radius: var(--radius-l);
    }

    /* Module grid */
    .modules-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap:12px;
      margin-top:14px;
    }
    .module-item{
      padding:16px;
      border-radius: var(--radius-m);
      border:2px solid transparent;
      background: rgba(255,255,255,0.75);
      cursor:pointer;
      transition: all .2s var(--ease);
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      user-select:none;
    }
    .module-item:hover{transform: translateY(-2px);}
    .module-item.selected{
      border-color: var(--primary);
      background: rgba(0,113,227,0.06);
    }
    .m-title{font-weight:850;font-size:.98rem;margin-bottom:6px;}
    .m-sub{font-size:.82rem;color: var(--text-sec);}

    /* Segmented controls */
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      background: rgba(0,0,0,0.05);
      color: var(--text-sec);
      font-weight:850;
      cursor:pointer;
      transition: all .2s var(--ease);
      user-select:none;
    }
    .seg button:hover{background: rgba(0,0,0,0.08);}
    .seg button.active{
      background: rgba(0,113,227,0.12);
      color: var(--primary);
    }

    /* Charts */
    .chart-wrap{
      margin-top:14px;
      border-radius: var(--radius-l);
      padding:14px;
      background: rgba(255,255,255,0.55);
      border:1px solid rgba(0,0,0,0.06);
    }
    canvas{width:100%; display:block;}
    .module-list{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      max-height:220px;
      overflow:auto;
      padding-right:2px;
    }
    @media (max-width: 720px){
      .module-list{grid-template-columns:1fr;}
    }
    .module-row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-radius: var(--radius-m);
      background: rgba(255,255,255,0.70);
      border:1px solid rgba(0,0,0,0.06);
      font-weight:850;
      color: var(--text-main);
    }
    .module-row .val{color: var(--primary);}

    /* Quiz view */
    .quiz-progress{height:6px;background: rgba(0,0,0,0.06); border-radius:999px; overflow:hidden; margin:8px 0 18px 0;}
    .quiz-bar{height:100%; background: var(--primary); width:0%; transition: width .35s ease;}

    .question-card{
      padding:32px 24px;
      text-align:center;
      border-radius: var(--radius-l);
      min-height:200px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:18px;
    }
    .q-text{font-size:1.35rem;font-weight:850;line-height:1.4;}
    .q-chip{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(0,113,227,0.10);
      border:1px solid rgba(0,113,227,0.12);
      color: var(--primary);
      font-weight:900;
      font-size:.82rem;
    }

    .options-stack{display:flex; flex-direction:column; gap:12px; padding-bottom:120px;}
    .opt-btn{
      width:100%;
      padding:20px 24px;
      text-align:left;
      border-radius: var(--radius-m);
      border:1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.85);
      font-size:1rem;
      font-weight:750;
      cursor:pointer;
      transition: all .2s var(--ease);
      box-shadow: 0 6px 16px rgba(0,0,0,0.03);
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .opt-btn:active{transform: scale(0.985);}
    .opt-btn.correct{background: #e8fce8; border-color: rgba(52,199,89,0.55); color:#0b5a22;}
    .opt-btn.wrong{background:#ffebeb; border-color: rgba(255,59,48,0.55); color:#8a1111;}
    .opt-btn:disabled{cursor:default; opacity:1;}

    /* Floating bars */
    .float-bar{
      position:absolute;
      bottom:24px;
      left:50%;
      transform: translateX(-50%);
      width: min(92%, 640px);
      padding:10px;
      border-radius:999px;
      display:flex;
      gap:10px;
      z-index:50;
      opacity:0;
      pointer-events:none;
      transition: all .3s var(--ease);
    }
    .float-bar.visible{opacity:1; pointer-events:auto; bottom:32px;}
    .float-mini{
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.65);
      color: var(--text-sec);
      font-weight:850;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .float-mini strong{color: var(--text-main);}
    .float-btn{
      flex:1;
      padding:14px 16px;
      border-radius:999px;
      border:none;
      background: var(--primary);
      color:white;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 14px 34px rgba(0,113,227,0.25);
      transition: transform .2s var(--ease), opacity .2s var(--ease);
    }
    .float-btn:active{transform: scale(0.985);}
    .float-btn:disabled{opacity:.45; cursor:not-allowed; transform:none;}
    .float-btn.secondary{
      background: rgba(0,0,0,0.06);
      color: var(--text-main);
      box-shadow:none;
    }

    /* Modal */
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.36);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index:200;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal-overlay.active{display:flex; animation: fadeIn .18s ease;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{
      width:min(520px, 100%);
      border-radius: 28px;
      padding: 22px;
      position:relative;
    }
    .modal h3{margin:0 0 6px 0; font-weight:900;}
    .modal p{margin:0 0 14px 0; color: var(--text-sec); line-height:1.45;}
    .modal .x{
      position:absolute; top:14px; right:14px;
      width:40px;height:40px;border-radius:50%;
      border:none;background: rgba(0,0,0,0.05);
      cursor:pointer;
    }
    .error{
      margin-top:10px;
      padding:12px 14px;
      border-radius: var(--radius-m);
      background: rgba(255,59,48,0.10);
      border: 1px solid rgba(255,59,48,0.20);
      color: #8a1111;
      font-weight:800;
      display:none;
    }

    /* Small helpers */
    .hidden{display:none !important;}
    .pill-link{
      border:none;
      background:transparent;
      color: var(--primary);
      font-weight:850;
      cursor:pointer;
      padding:0;
    }
    .divider{height:1px; background: rgba(0,0,0,0.06); margin:16px 0;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  
    /* Toasts */
    .toast-stack{
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
      width: min(92vw, 460px);
    }
    .toast{
      pointer-events: auto;
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,0.68);
      border: 1px solid rgba(255,255,255,0.70);
      box-shadow: 0 16px 46px rgba(0,0,0,0.12);
      -webkit-backdrop-filter: blur(18px);
      backdrop-filter: blur(18px);
      overflow: hidden;
      position: relative;
    }
    .toast::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 3px;
      background: rgba(0,113,227,0.95);
    }
    .toast.success::before{ background: rgba(52,199,89,0.95); }
    .toast.warn::before{ background: rgba(255,159,10,0.95); }
    .toast.danger::before{ background: rgba(255,59,48,0.95); }
    .toast h4{ margin:0; font-size: 13px; letter-spacing: .2px; }
    .toast p{ margin:3px 0 0; color: var(--text-sec); font-size: 12.5px; line-height: 1.35; }
    .toast .t-actions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .toast .t-btn{
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 750;
      font-size: 12px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.65);
      cursor: pointer;
    }
    .toast .t-btn.primary{
      background: rgba(0,113,227,0.92);
      border-color: rgba(0,113,227,0.55);
      color: #fff;
    }
    .toast .t-x{
      margin-left:auto;
      border:none;
      background:transparent;
      cursor:pointer;
      opacity:.6;
      font-size: 16px;
      line-height: 1;
      padding: 2px 6px;
    }
    .toast .t-x:hover{ opacity: 1; }

    /* Auth success panel */
    .notice{
      padding: 14px;
      border-radius: 18px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.65);
      box-shadow: 0 16px 46px rgba(0,0,0,0.06);
    }
    .notice-title{ margin:0; font-size: 15px; font-weight: 850; }
    .notice-sub{ margin:6px 0 0; color: var(--text-sec); font-size: 13px; line-height: 1.35; }

  </style>
</head>

<body>
  <div class="ambient-bg"></div>

  <div class="app-shell">
    <header>
      <div class="logo-area">
        <div class="logo-icon">M</div>
        <div>
          <div class="app-name">MedMastery</div>
          <div style="color:var(--text-sec);font-weight:750;font-size:.9rem;margin-top:2px;" id="crumb">Corsi</div>
        </div>
      </div>

      <div class="nav-actions">
        <button class="btn-icon" title="Home" aria-label="Home" onclick="goHome()">‚åÇ</button>
      </div>
    </header>

    <div class="view-container">
      <!-- DASHBOARD -->
      <section id="view-dashboard" class="view active">
        <div class="section-header">
          <h2 class="h2-title">Corsi disponibili</h2>
          <p class="h-sub">Scegli un corso. Statistiche, errori e ripasso si sbloccano col login.</p>
        </div>

        <div class="glass-panel panel" style="margin-bottom:18px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-weight:900;">Account</h3>
              <p class="h-sub" style="margin-top:6px;" id="user-display-dash">Ospite (login opzionale)</p>
            </div>
            <span class="chip" id="chip-auth">üîí Ospite</span>
          </div>

          <div id="dash-loggedout">
            <div style="height:10px"></div>
            <div class="inline-row">
              <button class="btn-primary blue" style="max-width:220px;" onclick="openAuth('login')">Accedi</button>
              <button class="btn-secondary" style="max-width:220px;" onclick="openAuth('signup')">Registrati</button>
            </div>
            <p class="h-sub" style="margin-top:12px;">Con il login sblocchi grafici, errori e ripasso (separati per corso).</p>
          </div>

          <div id="dash-loggedin" class="hidden">
            <div style="height:10px"></div>
            <div class="inline-row">
              <button class="btn-secondary" style="max-width:220px;" onclick="openAuth('login')">Gestisci account</button>
              <button class="btn-secondary" style="max-width:220px;" onclick="switchAccount()">Cambia account</button>
              <button class="btn-secondary" style="max-width:220px; border-color: rgba(255,59,48,0.35);" onclick="logout()">Esci</button>
            </div>
          </div>
        </div>
        <div class="grid-courses" id="courses-grid"></div>
      </section>


      <!-- AUTH -->
      <section id="view-auth" class="view">
        <div class="top-bar">
          <div class="back-btn" onclick="navBackFromAuth()">‚Üê Indietro</div>
        </div>

        <div class="section-header">
          <h2 class="h2-title">Account</h2>
          <p class="h-sub">Login email + password per salvare statistiche, errori e ripasso.</p>
        </div>

        <div class="glass-panel panel">
          <h3 id="auth-title" style="margin:0;">Accedi</h3>
          <p id="auth-sub" class="h-sub" style="margin-top:8px;">Email + password. Statistiche separate per corso.</p>

          <div class="divider"></div>

          <p id="user-display" style="margin:0; font-weight:850;">Ospite</p>
          <div style="height:10px"></div>

          <div class="error" id="auth-error"></div>

          <!-- In-app feedback (no browser alert) -->
          <div id="auth-success" class="notice hidden" style="margin-top:12px;">
            <p class="notice-title" id="auth-success-title">Operazione completata</p>
            <p class="notice-sub" id="auth-success-sub">‚Äî</p>
            <div class="divider" style="margin:12px 0;"></div>
            <div class="inline-row" style="flex-wrap:wrap;">
              <button class="btn-primary blue" id="auth-success-primary" onclick="authSuccessPrimary()">Vai ai corsi</button>
              <button class="btn-secondary" id="auth-success-secondary" onclick="authSuccessSecondary()">Accedi</button>
            </div>
          </div>


          <!-- When logged out -->
          <div id="profile-loggedout">
            <div id="auth-login">
              <div class="input-group">
                <label class="input-label">Email</label>
                <input class="input-field" id="loginEmail" type="email" autocomplete="email" placeholder="nome@scuola.it" />
              </div>
              <div class="input-group">
                <label class="input-label">Password</label>
                <input class="input-field" id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>
              <button class="btn-primary blue" onclick="login()">Accedi</button>
              <div style="height:10px"></div>
              <button class="btn-secondary" onclick="openAuth('signup')">Non hai un account? Registrati</button>
            </div>

            <div id="auth-signup" class="hidden">
              <div class="input-group">
                <label class="input-label">Username</label>
                <input class="input-field" id="signupUser" type="text" autocomplete="nickname" placeholder="Es: Ludovico" />
              </div>
              <div class="input-group">
                <label class="input-label">Email</label>
                <input class="input-field" id="signupEmail" type="email" autocomplete="email" placeholder="nome@scuola.it" />
              </div>
              <div class="input-group">
                <label class="input-label">Password (min 8)</label>
                <input class="input-field" id="signupPass" type="password" autocomplete="new-password" placeholder="Min 8 caratteri" />
              </div>
              <button class="btn-primary blue" onclick="signup()">Crea account</button>
              <div style="height:10px"></div>
              <button class="btn-secondary" onclick="openAuth('login')">Hai gi√† un account? Accedi</button>
            </div>

            <p class="h-sub" style="margin-top:14px;">
              Tip: in sviluppo puoi disattivare ‚ÄúConfirm email‚Äù su Supabase Auth.
            </p>
          </div>

          <!-- When logged in -->
          <div id="profile-loggedin" class="hidden">
            <p class="h-sub">Sei loggato. Le statistiche vengono salvate automaticamente.</p>
            <div style="height:12px"></div>
            <div class="inline-row">
              <button class="btn-primary" style="max-width:240px;" onclick="navTo('dashboard')">Vai ai corsi</button>
              <button class="btn-secondary" style="max-width:240px;" onclick="switchAccount()">Cambia account</button>
              <button class="btn-secondary" style="max-width:200px; border-color: rgba(255,59,48,0.35);" onclick="logout()">Esci</button>
            </div>
          </div>
        </div>
      </section>

      <!-- COURSE -->
      <section id="view-course" class="view">
        <div class="top-bar">
          <div class="back-btn" onclick="navTo('dashboard')">‚Üê Corsi</div>
        </div>

        <div class="section-header">
          <h2 class="h2-title" id="course-title">Corso</h2>
          <p class="h-sub" id="course-desc">‚Äî</p>
        </div>

        <div class="stats-row">
          <div class="glass-panel stat-card">
            <div class="stat-val" id="stat-avg">‚Äî%</div>
            <div class="stat-label">Media corso</div>
            <div class="stat-mini" id="stat-avg-sub">Accedi per vedere la tua media in questo corso.</div>
          </div>
          <div class="glass-panel stat-card">
            <div class="stat-val" id="stat-done">‚Äî</div>
            <div class="stat-label">Quiz svolti</div>
            <div class="stat-mini" id="stat-done-sub">Accedi per vedere la cronologia dei quiz.</div>
          </div>
        </div>

        <!-- Progress chart -->
        <div class="glass-panel panel" id="panel-progress">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:14px; flex-wrap:wrap;">
            <h3 style="margin:0; font-weight:900;">Andamento</h3>
            <div class="seg">
              <button id="btn-line" class="active" onclick="setProgressType('line')">Linea</button>
              <button id="btn-bar" onclick="setProgressType('bar')">Istogramma</button>
            </div>
          </div>
          <p class="h-sub" style="margin-top:8px;">Ultimi 30 quiz in questo corso.</p>
          <div class="chart-wrap">
            <canvas id="progressChart" height="130"></canvas>
          </div>
          <div class="divider"></div>
          <div class="inline-row">
            <button class="btn-secondary" style="max-width:220px;" id="btn-wrong" onclick="openQuizSettings('wrong')">‚ö†Ô∏è Quiz errori</button>
            <button class="btn-secondary" style="max-width:240px;" id="btn-old" onclick="openQuizSettings('old')">üï∞Ô∏è Ripasso vecchie</button>
            <div style="color:var(--text-sec);font-weight:800;">
              Errori: <strong id="wrong-count">‚Äî</strong> ‚Ä¢ Vecchia: <strong id="oldest-label">‚Äî</strong>
            </div>
          </div>
          <div class="error" id="locked-hint">
            Questa sezione richiede login (email+password).
            <div style="height:10px"></div>
            <button class="btn-primary blue" style="max-width:220px;" onclick="openAuth('login')">Accedi</button>
          </div>
        </div>

        <!-- Module accuracy -->
        <div class="glass-panel panel hidden" id="panel-modules">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:14px; flex-wrap:wrap;">
            <h3 style="margin:0; font-weight:900;">Accuratezza per modulo</h3>
            <span class="chip">calcolata da <span class="mono">question_progress</span></span>
          </div>
          <div class="chart-wrap">
            <canvas id="moduleChart" height="180"></canvas>
          </div>
          <div class="module-list" id="moduleList"></div>
        </div>

        <!-- Search -->
        <div class="glass-panel panel">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-weight:900;">Ricerca nel corso</h3>
              <p class="h-sub">Cerca parole chiave e costruisci un quiz dai risultati.</p>
            </div>
            <button class="btn-secondary" style="max-width:160px;" id="btn-search-start" onclick="openQuizSettings('search')" disabled>Avvia</button>
          </div>
          <div style="height:10px"></div>
          <input class="input-field" id="search" placeholder="Es: talamo, cornea, Murphy..." oninput="onSearch()" />
          <div style="margin-top:14px; display:flex; flex-direction:column; gap:12px; max-height:260px; overflow:auto;" id="searchResults"></div>
        </div>

        <!-- Modules selection -->
        <div class="glass-panel panel">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
            <div>
              <h3 style="margin:0; font-weight:900;">Moduli</h3>
              <p class="h-sub">Seleziona i moduli, poi scegli quante domande quando avvii il quiz.</p>
            </div>
            <button class="pill-link" onclick="selectAllModules()">Seleziona tutti</button>
          </div>

          <div class="modules-grid" id="modules-list"></div>
          <div style="height:12px"></div>

          <div class="inline-row">
            <button class="btn-secondary" style="max-width:220px;" onclick="clearModules()">Deseleziona</button>
            <button class="btn-secondary" style="max-width:260px;" onclick="openQuizSettings('course_exam')">üéì Simulazione corso</button>
          </div>
        </div>

        <div style="height:80px;"></div>
      </section>

      <!-- QUIZ -->
      <section id="view-quiz" class="view">
        <div class="top-bar" style="justify-content:space-between;">
          <div class="back-btn" onclick="quitQuiz()">‚úï Esci</div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span class="q-chip" id="q-chip">‚Äî</span>
            <div style="font-weight:800; color:var(--text-sec);" id="q-counter">1 / 10</div>
          </div>
        </div>

        <div class="quiz-progress">
          <div class="quiz-bar" id="progress-bar"></div>
        </div>

        <div class="glass-panel question-card">
          <div class="q-text" id="q-text">Caricamento domanda...</div>
        </div>

        <div class="options-stack" id="options-container"></div>
      </section>

      <!-- RESULTS -->
      <section id="view-results" class="view" style="text-align:center; justify-content:center;">
        <div class="glass-panel" style="padding:40px; border-radius:32px; display:inline-flex; flex-direction:column; align-items:center; max-width:420px; margin:0 auto;">
          <div style="width:120px; height:120px; border-radius:50%; background:#f5f5f7; display:flex; align-items:center; justify-content:center; margin-bottom:20px; box-shadow:inset 0 4px 12px rgba(0,0,0,0.05);">
            <div style="font-size:2.5rem; font-weight:900; color:var(--primary);" id="final-score">80%</div>
          </div>
          <h2 class="h2-title" style="margin:0;">Sessione completata</h2>
          <p class="h-sub" id="final-msg" style="margin:10px 0 26px 0;">Ottimo lavoro.</p>

          <div style="display:flex; gap:10px; width:100%; flex-wrap:wrap;">
            <button class="btn-primary blue" style="flex:1; min-width:180px;" onclick="backToCourse()">Torna al corso</button>
            <button class="btn-secondary" style="flex:1; min-width:180px;" onclick="navTo('dashboard')">Corsi</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Floating: Start button in course -->
    <div class="glass-panel float-bar" id="course-actions">
      <div class="float-mini">Selezionati: <strong id="sel-count">0</strong></div>
      <button class="float-btn" id="btn-start" disabled onclick="openQuizSettings('modules')">Avvia Quiz</button>
      <button class="float-btn secondary" onclick="navTo('dashboard')">Chiudi</button>
    </div>

    <!-- Floating: next in quiz -->
    <div class="glass-panel float-bar" id="quiz-actions" style="width:min(92%, 260px);">
      <button class="float-btn" onclick="nextQuestion()">Prossima ‚Üí</button>
    </div>
  </div>

  <!-- Quiz settings modal -->
  <div class="modal-overlay" id="settings-modal" onclick="if(event.target===this) closeSettings()">
    <div class="glass-panel modal" role="dialog" aria-modal="true">
      <button class="x" aria-label="Chiudi" onclick="closeSettings()">‚úï</button>
      <h3>Impostazioni quiz</h3>
      <p id="settings-desc">Scegli quante domande vuoi fare.</p>

      <div class="input-group">
        <label class="input-label">Numero domande (0 = tutte)</label>
        <div class="inline-row">
          <input class="input-field" id="settings-limit" type="number" min="0" value="20" />
          <button class="btn-secondary" style="max-width:160px;" onclick="setQuickLimit(10)">10</button>
          <button class="btn-secondary" style="max-width:160px;" onclick="setQuickLimit(20)">20</button>
          <button class="btn-secondary" style="max-width:160px;" onclick="setQuickLimit(0)">Tutte</button>
        </div>
      </div>

      <div class="divider"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn-secondary" style="flex:1; min-width:180px;" onclick="closeSettings()">Annulla</button>
        <button class="btn-primary blue" style="flex:1; min-width:180px;" id="settings-start" onclick="startFromSettings()">Avvia</button>
      </div>
      <div class="error" id="settings-error"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /***********************************************************************
     * SUPABASE CONFIG
     * - Inserisci le tue credenziali
     **********************************************************************/
    const SUPABASE_URL = "https://sfuiguqwifkztkhrfoti.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmdWlndXF3aWZrenRraHJmb3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTcwMDksImV4cCI6MjA4MjE3MzAwOX0.UTRUFAonpK9Amqt_ZNxk-5fr-Ert7ZKKeRAi7Svz8ig";

    const supa = (SUPABASE_URL.includes("YOUR_PROJECT") || SUPABASE_ANON_KEY.includes("YOUR_ANON"))
      ? null
      : supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************************************************************
     * QUIZ PACKS (MODULARI)
     * - Aggiungi corsi qui.
     * - Formato domanda: { q:"...", a:["corretta","errata","errata","errata"], cat?:"..." }
     **********************************************************************/
    const QUIZ_PACKS = {
      neuro: {
        id: "neuro",
        title: "Neuroanatomia",
        desc: "Tronco encefalico, midollo, vie e concetti base.",
        icon: "üß†",
        modules: {
          "Introduzione": [
            { q: "Qual √® la funzione principale del tessuto nervoso?", a: ["Ricevere e trasmettere segnali elettrici", "Produrre ormoni", "Filtrare il sangue", "Contrarsi come muscolo"], cat:"Base" },
            { q: "Il sistema nervoso centrale comprende:", a: ["Encefalo e midollo spinale", "Nervi cranici e spinali", "Gangli periferici", "Plessi nervosi"], cat:"Base" },
            { q: "La sostanza bianca √® formata soprattutto da:", a: ["Assoni mielinizzati", "Corpi cellulari", "Capillari", "Liquor"], cat:"Istologia" },
            { q: "Le cellule che producono mielina nel SNC sono:", a: ["Oligodendrociti", "Cellule di Schwann", "Microglia", "Astrociti"], cat:"Glia" },
            { q: "La microglia deriva da:", a: ["Linee monocito-macrofagiche", "Neuroectoderma", "Ectoderma superficiale", "Endoderma"], cat:"Glia" }
          ],
          "Tronco encefalico": [
            { q: "L'ordine caudo-craniale del tronco encefalico √®:", a: ["Bulbo, ponte, mesencefalo", "Ponte, bulbo, mesencefalo", "Mesencefalo, ponte, bulbo", "Bulbo, mesencefalo, ponte"], cat:"Anatomia" },
            { q: "Nel solco basilare del ponte decorre:", a: ["Arteria basilare", "Arteria cerebrale media", "Acquedotto di Silvio", "Nervo ottico"], cat:"Vasi" },
            { q: "Le piramidi bulbari contengono:", a: ["Fibre cortico-spinali", "Fibre spino-talamiche", "Fibre commissurali", "Fibre olivo-cerebellari"], cat:"Vie" },
            { q: "Dal solco anterolaterale del bulbo emerge tipicamente:", a: ["Nervo ipoglosso (XII)", "Nervo trigemino (V)", "Nervo olfattivo (I)", "Nervo abducente (VI)"], cat:"NC" },
            { q: "La decussazione delle piramidi riguarda circa:", a: ["80% delle fibre", "100% delle fibre", "20% delle fibre", "50% delle fibre"], cat:"Vie" }
          ]
        }
      },

      semeiotica: {
        id: "semeiotica",
        title: "Semeiotica",
        desc: "Addome e torace: segni clinici fondamentali.",
        icon: "ü©∫",
        modules: {
          "Addome": [
            { q: "Il segno di Murphy √® positivo quando:", a: ["Dolore e arresto inspiratorio alla palpazione ipocondrio dx", "Dolore alla fossa iliaca dx", "Ittero improvviso", "Vomito incoercibile"], cat:"Addome" },
            { q: "La peritonite d√† tipicamente:", a: ["Addome 'a tavola' e dolorabilit√† diffusa", "Murmullo vescicolare ridotto", "Edema declive", "Cianosi"], cat:"Addome" },
            { q: "La manovra di Blumberg valuta:", a: ["Dolore da rimbalzo per irritazione peritoneale", "Fremito vocale tattile", "Riflesso corneale", "Polso paradosso"], cat:"Addome" },
            { q: "La splenomegalia si ricerca meglio:", a: ["Con palpazione bimanuale in inspirazione profonda", "Con percussione toracica", "Con test di Romberg", "Con manovra di Las√®gue"], cat:"Addome" },
            { q: "L'ascite si conferma con:", a: ["Segno dell'onda e ottusit√† mobile", "Segno di Babinski", "Segno di Kernig", "Segno di Homan"], cat:"Addome" }
          ],
          "Torace": [
            { q: "Il fremito vocale tattile diminuisce in:", a: ["Versamento pleurico", "Consolidamento polmonare", "Fibrosi iniziale", "Asma lieve"], cat:"Torace" },
            { q: "La crepitazione fine bibasale pu√≤ indicare:", a: ["Edema polmonare", "Appendicite", "Otite", "Emicrania"], cat:"Torace" },
            { q: "In pneumotorace iperteso tipicamente trovi:", a: ["Ipotensione + trachea deviata controlateralmente", "Bradicardia e polso pieno", "Ittero", "Rigor nucale"], cat:"Torace" },
            { q: "La percussione iperfonica suggerisce:", a: ["Pneumotorace o enfisema", "Consolidamento", "Versamento", "Atelettasia completa"], cat:"Torace" },
            { q: "Il murmurio vescicolare √®:", a: ["Rumore respiratorio fisiologico", "Soffio cardiaco", "Rumore intestinale", "Tono muscolare"], cat:"Torace" }
          ]
        }
      },

      dermato: {
        id: "dermato",
        title: "Dermatologia",
        desc: "Lesioni elementari e diagnosi rapide.",
        icon: "üß¥",
        modules: {
          "Lesioni elementari": [
            { q: "Una macula √®:", a: ["Lesione piana con variazione di colore", "Lesione rilevata con pus", "Nodulo profondo", "Ulcerazione"], cat:"Base" },
            { q: "Una papula √®:", a: ["Lesione rilevata solida < 1 cm", "Lesione piana pigmentata", "Vescicola piena di liquido", "Placca estesa > 10 cm"], cat:"Base" },
            { q: "Una vescicola contiene:", a: ["Liquido chiaro", "Pus", "Sangue sempre", "Cheratina dura"], cat:"Base" },
            { q: "Una pustola √®:", a: ["Lesione contenente pus", "Lesione piana", "Cicatrice", "Ulcera profonda"], cat:"Base" },
            { q: "La placca √® spesso:", a: ["Confluenza di papule (rilevata e ampia)", "Solo una macula", "Solo un nodulo", "Un'ulcera"], cat:"Base" }
          ],
          "Diagnosi rapide": [
            { q: "Orticaria tipicamente presenta:", a: ["Pomfi pruriginosi migranti", "Comedoni", "Vescicole dolorose lungo un dermatomero", "Placche argentate croniche"], cat:"Clinica" },
            { q: "Psoriasi tipica:", a: ["Placche eritemato-desquamative", "Bolle flaccide diffuse", "Macchie ipopigmentate isolate", "Lesioni purulente in piega"], cat:"Clinica" },
            { q: "Herpes zoster:", a: ["Vescicole dolorose a distribuzione metamerica", "Papule acneiche", "Macule diffuse non dolorose", "Orticaria migrante"], cat:"Clinica" },
            { q: "Tinea corporis spesso d√†:", a: ["Lesione anulare con bordo attivo desquamante", "Pomfi migranti", "Bolle emorragiche", "Ulcere necrotiche"], cat:"Infettive" },
            { q: "La scabbia causa:", a: ["Prurito notturno + cunicoli", "Alopecia a chiazze", "Iperidrosi isolata", "Teleangectasie diffuse"], cat:"Infettive" }
          ]
        }
      }
    };

    /***********************************************************************
     * STATE
     **********************************************************************/
    const state = {
      isLogged: false,
      currentUser: null,
      profile: null,

      currentCourseId: null,
      selectedModules: new Set(),

      // search
      searchHits: [],

      // quiz
      mode: null, // modules | course_exam | wrong | old | search
      quizQuestions: [],
      quizIndex: 0,
      quizCorrect: 0,
      quizAnswered: false,

      // settings modal
      pendingMode: null
    };

    // Q map for stable qids
    const QMAP = {};
    buildQuestionMaps();

    function buildQuestionMaps(){
      for (const cId of Object.keys(QUIZ_PACKS)){
        QMAP[cId] = {};
        const pack = QUIZ_PACKS[cId];
        for (const mod of Object.keys(pack.modules)){
          pack.modules[mod].forEach((qq) => {
            const qid = makeQid(cId, mod, qq.q);
            QMAP[cId][qid] = { module: mod, cat: qq.cat || mod, q: qq.q, a: qq.a };
          });
        }
      }
    }

    /***********************************************************************
     * DOM refs
     **********************************************************************/
    const crumbEl = document.getElementById("crumb");
    const chipAuth = document.getElementById("chip-auth");

    // views
    const vDashboard = document.getElementById("view-dashboard");
    const vCourse = document.getElementById("view-course");
    const vQuiz = document.getElementById("view-quiz");
    const vResults = document.getElementById("view-results");

    // dashboard
    const coursesGrid = document.getElementById("courses-grid");

    // course
    const courseTitle = document.getElementById("course-title");
    const courseDesc = document.getElementById("course-desc");
    const modulesList = document.getElementById("modules-list");

    const statAvg = document.getElementById("stat-avg");
    const statDone = document.getElementById("stat-done");
    const statAvgSub = document.getElementById("stat-avg-sub");
    const statDoneSub = document.getElementById("stat-done-sub");

    const lockedHint = document.getElementById("locked-hint");
    const btnWrong = document.getElementById("btn-wrong");
    const btnOld = document.getElementById("btn-old");
    const wrongCountEl = document.getElementById("wrong-count");
    const oldestLabelEl = document.getElementById("oldest-label");

    const panelModules = document.getElementById("panel-modules");
    const moduleListEl = document.getElementById("moduleList");

    const searchEl = document.getElementById("search");
    const searchResultsEl = document.getElementById("searchResults");
    const btnSearchStart = document.getElementById("btn-search-start");

    // float bar
    const courseActions = document.getElementById("course-actions");
    const selCountEl = document.getElementById("sel-count");
    const btnStart = document.getElementById("btn-start");
    const quizActions = document.getElementById("quiz-actions");

    // quiz
    const qChip = document.getElementById("q-chip");
    const qCounter = document.getElementById("q-counter");
    const progressBar = document.getElementById("progress-bar");
    const qText = document.getElementById("q-text");
    const optionsContainer = document.getElementById("options-container");

    // results
    const finalScore = document.getElementById("final-score");
    const finalMsg = document.getElementById("final-msg");

    // auth / account UI
    const vAuth = document.getElementById("view-auth");
    const userDisplay = document.getElementById("user-display");
    const userDisplayDash = document.getElementById("user-display-dash");
    const profileLoggedOut = document.getElementById("profile-loggedout");
    const profileLoggedIn = document.getElementById("profile-loggedin");
    const dashLoggedOut = document.getElementById("dash-loggedout");
    const dashLoggedIn = document.getElementById("dash-loggedin");

    // auth
    const authTitle = document.getElementById("auth-title");
    const authSub = document.getElementById("auth-sub");
    const authError = document.getElementById("auth-error");
    const authLogin = document.getElementById("auth-login");
    const authSignup = document.getElementById("auth-signup");

    // settings
    const settingsModal = document.getElementById("settings-modal");
    const settingsDesc = document.getElementById("settings-desc");
    const settingsLimit = document.getElementById("settings-limit");
    const settingsError = document.getElementById("settings-error");

    /***********************************************************************
     * Init
     **********************************************************************/
    renderCourses();
    refreshSelectionBar();

    if (!supa){
      console.warn("Supabase non configurato: inserisci SUPABASE_URL e SUPABASE_ANON_KEY.");
      setAuthUI(null);
    } else {
      supa.auth.onAuthStateChange((_event,_session) => refreshAuthState());
      refreshAuthState();
    }

    window.addEventListener("resize", () => {
      try{ drawProgressChart(__progressPoints); }catch(e){}
      try{ drawModuleChart(__moduleLabels, __moduleValues); }catch(e){}
    });

    /***********************************************************************
     * Navigation
     **********************************************************************/
    function navTo(viewId){
      document.querySelectorAll(".view").forEach(el => el.classList.remove("active"));
      document.getElementById("view-" + viewId).classList.add("active");

      // floating bars
      courseActions.classList.remove("visible");
      quizActions.classList.remove("visible");

      if (viewId === "course"){
        courseActions.classList.add("visible");
      }
    }

    function goHome(){
      if (vQuiz.classList.contains("active")){
        if(!confirm("Vuoi uscire dal quiz? Perderai i progressi di questa sessione.")) return;
      }
      state.currentCourseId = null;
      state.selectedModules.clear();
      crumbEl.textContent = "Corsi";
      navTo("dashboard");
    }

    function backToCourse(){
      if (!state.currentCourseId){ goHome(); return; }
      navTo("course");
      refreshCourseDashboard();
    }

    /***********************************************************************
     * Dashboard: courses
     **********************************************************************/
    function renderCourses(){
      coursesGrid.innerHTML = "";
      Object.values(QUIZ_PACKS).forEach(c => {
        const qCount = Object.values(c.modules).reduce((acc, a)=> acc + a.length, 0);
        const mCount = Object.keys(c.modules).length;

        const card = document.createElement("div");
        card.className = "glass-panel course-card";
        card.onclick = () => openCourse(c.id);

        card.innerHTML = `
          <div>
            <div class="course-icon">${c.icon || "üìö"}</div>
            <div class="course-info">
              <h3>${escapeHtml(c.title)}</h3>
              <p>${escapeHtml(c.desc || "")}</p>
            </div>
          </div>
          <div class="course-stats">
            <span class="badge">${mCount} Moduli</span>
            <span class="badge">${qCount} Domande</span>
            <span class="badge">${state.isLogged ? "Progressi attivi" : "Login opzionale"}</span>
          </div>
        `;
        coursesGrid.appendChild(card);
      });
    }

    function openCourse(courseId){
      state.currentCourseId = courseId;
      state.selectedModules.clear();
      state.searchHits = [];
      searchEl.value = "";
      searchResultsEl.innerHTML = "";
      btnSearchStart.disabled = true;

      const c = QUIZ_PACKS[courseId];
      crumbEl.textContent = `Corsi ‚Ä¢ ${c.title}`;
      courseTitle.textContent = c.title;
      courseDesc.textContent = c.desc || "";

      renderModulesSelection();
      refreshSelectionBar();
      navTo("course");
      refreshCourseDashboard();
    }

    /***********************************************************************
     * Modules selection
     **********************************************************************/
    function renderModulesSelection(){
      modulesList.innerHTML = "";
      const course = QUIZ_PACKS[state.currentCourseId];
      const mods = Object.keys(course.modules);

      mods.forEach(m => {
        const item = document.createElement("div");
        item.className = "module-item";
        item.onclick = () => toggleModule(m, item);
        item.innerHTML = `
          <div class="m-title">${escapeHtml(m)}</div>
          <div class="m-sub">${course.modules[m].length} domande</div>
        `;
        modulesList.appendChild(item);
      });
    }

    function toggleModule(m, el){
      if (state.selectedModules.has(m)){
        state.selectedModules.delete(m);
        el.classList.remove("selected");
      } else {
        state.selectedModules.add(m);
        el.classList.add("selected");
      }
      refreshSelectionBar();
    }

    function selectAllModules(){
      const course = QUIZ_PACKS[state.currentCourseId];
      state.selectedModules = new Set(Object.keys(course.modules));
      renderModulesSelection();
      // mark all selected
      document.querySelectorAll(".module-item").forEach(el => el.classList.add("selected"));
      refreshSelectionBar();
    }

    function clearModules(){
      state.selectedModules.clear();
      document.querySelectorAll(".module-item").forEach(el => el.classList.remove("selected"));
      refreshSelectionBar();
    }

    function refreshSelectionBar(){
      const count = countSelectedQuestions();
      selCountEl.textContent = String(count);
      btnStart.disabled = state.selectedModules.size === 0;
    }

    function countSelectedQuestions(){
      if (!state.currentCourseId) return 0;
      const course = QUIZ_PACKS[state.currentCourseId];
      let count = 0;
      state.selectedModules.forEach(m => count += (course.modules[m]?.length || 0));
      return count;
    }

    /***********************************************************************
     * Search (within course)
     **********************************************************************/
    function onSearch(){
      const q = (searchEl.value || "").trim().toLowerCase();
      searchResultsEl.innerHTML = "";
      state.searchHits = [];
      btnSearchStart.disabled = true;

      if (!q || q.length < 2) return;

      const map = QMAP[state.currentCourseId] || {};
      const hits = Object.entries(map)
        .map(([qid, obj]) => ({ qid, ...obj }))
        .filter(x => x.q.toLowerCase().includes(q) || (x.cat||"").toLowerCase().includes(q) || x.module.toLowerCase().includes(q))
        .slice(0, 40);

      hits.forEach(h => {
        const card = document.createElement("div");
        card.className = "glass-panel";
        card.style.borderRadius = "20px";
        card.style.padding = "14px";
        card.style.cursor = "pointer";

        const selected = state.searchHits.includes(h.qid);
        card.onclick = () => {
          if (state.searchHits.includes(h.qid)){
            state.searchHits = state.searchHits.filter(x => x !== h.qid);
          } else {
            state.searchHits.push(h.qid);
          }
          onSearch();
        };

        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
            <div style="font-weight:850;">${escapeHtml(trim(h.q, 120))}</div>
            <span class="badge" style="white-space:nowrap;">${escapeHtml(h.module)}</span>
          </div>
          <div style="margin-top:8px;color:var(--text-sec);font-weight:750;">${escapeHtml(h.cat || "")}</div>
          <div style="margin-top:10px;color:${selected ? "var(--primary)" : "var(--text-sec)"};font-weight:850;">
            ${selected ? "‚úì Aggiunta al quiz" : "Clicca per aggiungere"}
          </div>
        `;
        searchResultsEl.appendChild(card);
      });

      btnSearchStart.disabled = state.searchHits.length === 0;
    }

    /***********************************************************************
     * Course dashboard (Supabase data)
     **********************************************************************/
    let progressType = "line";
    let __progressPoints = [];
    let __moduleLabels = [];
    let __moduleValues = [];

    function setProgressType(type){
      progressType = type;
      document.getElementById("btn-line").classList.toggle("active", type==="line");
      document.getElementById("btn-bar").classList.toggle("active", type==="bar");
      drawProgressChart(__progressPoints);
    }

    async function refreshCourseDashboard(){
      // reset UI
      lockedHint.style.display = "none";
      btnWrong.disabled = true;
      btnOld.disabled = true;
      wrongCountEl.textContent = "‚Äî";
      oldestLabelEl.textContent = "‚Äî";
      panelModules.classList.add("hidden");
      drawProgressChart([]);

      if (!state.isLogged || !supa){
        statAvg.textContent = "‚Äî%";
        statDone.textContent = "‚Äî";
        statAvgSub.textContent = "Accedi per vedere la tua media in questo corso.";
        statDoneSub.textContent = "Accedi per vedere la cronologia dei quiz.";
        lockedHint.style.display = "block";
        return;
      }

      const courseId = state.currentCourseId;

      // attempts
      const { data: attempts, error: aErr } = await supa
        .from("quiz_attempts")
        .select("percent, created_at")
        .eq("user_id", state.currentUser.id)
        .eq("course_id", courseId)
        .order("created_at", { ascending: true })
        .limit(30);

      if (aErr) console.warn(aErr);

      const perc = (attempts || []).map(r => ({ percent: r.percent, created_at: r.created_at }));
      __progressPoints = perc;
      drawProgressChart(perc);

      const avg = perc.length ? Math.round(perc.reduce((s,o)=>s+(o.percent||0),0)/perc.length) : 0;
      statAvg.textContent = perc.length ? `${avg}%` : "‚Äî%";
      statAvgSub.textContent = perc.length ? `Basata su ${perc.length} quiz.` : "Non hai ancora quiz salvati in questo corso.";

      statDone.textContent = String((attempts || []).length);
      statDoneSub.textContent = "Quiz registrati (ultimi 30).";

      // question progress
      const { data: qp, error: qErr } = await supa
        .from("question_progress")
        .select("qid, module, correct, wrong, attempts, last_seen, last_wrong")
        .eq("user_id", state.currentUser.id)
        .eq("course_id", courseId);

      if (qErr) console.warn(qErr);

      const rows = qp || [];
      const wrongRows = rows.filter(r => (r.wrong || 0) > 0);
      wrongCountEl.textContent = String(wrongRows.length);
      btnWrong.disabled = wrongRows.length === 0;

      // oldest
      let oldest = null;
      for (const r of rows){
        const t = r.last_seen ? new Date(r.last_seen).getTime() : 0;
        if (!oldest || t < oldest.t){
          oldest = { t, qid: r.qid };
        }
      }
      if (oldest){
        const qObj = QMAP[courseId]?.[oldest.qid];
        oldestLabelEl.textContent = qObj ? `${qObj.module} ‚Ä¢ ${trim(qObj.q, 44)}` : "‚Äî";
        btnOld.disabled = rows.length === 0;
      } else {
        oldestLabelEl.textContent = "‚Äî";
        btnOld.disabled = true;
      }

      // module aggregation
      const modAgg = {};
      for (const r of rows){
        const m = r.module || "Senza modulo";
        if (!modAgg[m]) modAgg[m] = { c:0, a:0 };
        modAgg[m].c += (r.correct || 0);
        modAgg[m].a += (r.attempts || 0);
      }
      const labels = Object.keys(modAgg).sort((a,b)=>a.localeCompare(b));
      if (labels.length){
        const vals = labels.map(l => {
          const a = modAgg[l].a || 0;
          const c = modAgg[l].c || 0;
          return a ? Math.round((c/a)*100) : 0;
        });
        __moduleLabels = labels;
        __moduleValues = vals;
        panelModules.classList.remove("hidden");
        drawModuleChart(labels, vals);
        renderModuleList(labels, vals);
      }
    }

    function renderModuleList(labels, vals){
      moduleListEl.innerHTML = "";
      labels.forEach((l,i)=>{
        const row = document.createElement("div");
        row.className = "module-row";
        row.innerHTML = `<div>${escapeHtml(l)}</div><div class="val">${vals[i]}%</div>`;
        moduleListEl.appendChild(row);
      });
    }

    /***********************************************************************
     * Quiz settings flow (choose question count INSIDE start)
     **********************************************************************/
    function setQuickLimit(n){
      settingsLimit.value = String(n);
    }

    function openQuizSettings(mode){
      // login gate for modes that require data
      if ((mode === "wrong" || mode === "old") && !state.isLogged){
        openAuth("login");
        return;
      }
      if (mode === "search" && state.searchHits.length === 0) return;

      state.pendingMode = mode;

      // describe
      const course = QUIZ_PACKS[state.currentCourseId];
      const selCount = countSelectedQuestions();
      const totalCourse = Object.values(course.modules).reduce((s,a)=>s+a.length,0);

      let base = "";
      if (mode === "modules") base = `Quiz dai moduli selezionati (${selCount} disponibili).`;
      else if (mode === "course_exam") base = `Simulazione corso (tutti i moduli, ${totalCourse} domande).`;
      else if (mode === "wrong") base = `Quiz dagli errori recenti (solo questo corso).`;
      else if (mode === "old") base = `Ripasso delle domande pi√π vecchie (solo questo corso).`;
      else if (mode === "search") base = `Quiz dalle domande selezionate in ricerca (${state.searchHits.length}).`;

      settingsDesc.textContent = base + " Scegli quante domande vuoi fare.";

      settingsError.style.display = "none";
      settingsError.textContent = "";

      settingsModal.classList.add("active");
      // focus
      setTimeout(()=> settingsLimit.focus(), 50);
    }

    function closeSettings(){
      settingsModal.classList.remove("active");
      state.pendingMode = null;
    }

    async function startFromSettings(){
      const mode = state.pendingMode;
      if (!mode){ closeSettings(); return; }

      const raw = parseInt(settingsLimit.value || "20", 10);
      const limit = isNaN(raw) ? 20 : Math.max(0, raw);

      // gather questions
      let qs = [];
      let modulesLabel = [];

      const course = QUIZ_PACKS[state.currentCourseId];

      if (mode === "modules"){
        if (state.selectedModules.size === 0){
          settingsError.textContent = "Seleziona almeno un modulo.";
          settingsError.style.display = "block";
          return;
        }
        const mods = Array.from(state.selectedModules);
        modulesLabel = mods;
        qs = mods.flatMap(m => course.modules[m].map(qq => QMAP[state.currentCourseId][makeQid(state.currentCourseId, m, qq.q)]));
      }

      if (mode === "course_exam"){
        const mods = Object.keys(course.modules);
        modulesLabel = mods;
        qs = mods.flatMap(m => course.modules[m].map(qq => QMAP[state.currentCourseId][makeQid(state.currentCourseId, m, qq.q)]));
      }

      if (mode === "search"){
        modulesLabel = ["Ricerca"];
        qs = state.searchHits.map(qid => QMAP[state.currentCourseId][qid]).filter(Boolean);
      }

      if (mode === "wrong"){
        if (!supa || !state.isLogged) return;
        const { data, error } = await supa
          .from("question_progress")
          .select("qid, last_wrong, wrong")
          .eq("user_id", state.currentUser.id)
          .eq("course_id", state.currentCourseId)
          .gt("wrong", 0)
          .order("last_wrong", { ascending: false })
          .limit(250);

        if (error){
          settingsError.textContent = "Errore nel caricare gli errori.";
          settingsError.style.display = "block";
          return;
        }
        modulesLabel = ["Errori"];
        qs = (data || []).map(r => QMAP[state.currentCourseId][r.qid]).filter(Boolean);
      }

      if (mode === "old"){
        if (!supa || !state.isLogged) return;
        const { data, error } = await supa
          .from("question_progress")
          .select("qid, last_seen")
          .eq("user_id", state.currentUser.id)
          .eq("course_id", state.currentCourseId)
          .order("last_seen", { ascending: true, nullsFirst: true })
          .limit(250);

        if (error){
          settingsError.textContent = "Errore nel caricare il ripasso.";
          settingsError.style.display = "block";
          return;
        }
        modulesLabel = ["Ripasso"];
        qs = (data || []).map(r => QMAP[state.currentCourseId][r.qid]).filter(Boolean);
      }

      // start quiz
      closeSettings();
      state.mode = mode;
      startQuiz(qs, modulesLabel, limit);
    }

    /***********************************************************************
     * Quiz engine (with limit)
     **********************************************************************/
    function startQuiz(qs, modulesLabel, limit){
      // dedup
      const seen = new Set();
      let qList = qs.filter(Boolean).filter(x => {
        if (seen.has(x.q)) return false;
        seen.add(x.q);
        return true;
      });

      // shuffle questions
      qList = shuffle(qList);

      if (limit > 0) qList = qList.slice(0, limit);

      if (!qList.length){
        alert("Non ci sono domande disponibili per questa modalit√†.");
        return;
      }

      // build session questions with shuffled options
      state.quizQuestions = qList.map(x => {
        const correctText = x.a[0];
        const opts = shuffle([...x.a]);
        const correctIndex = opts.indexOf(correctText);
        return {
          course_id: state.currentCourseId,
          qid: makeQid(state.currentCourseId, x.module, x.q),
          module: x.module,
          cat: x.cat || x.module,
          q: x.q,
          options: opts,
          correctIndex
        };
      });

      state.quizIndex = 0;
      state.quizCorrect = 0;
      state.quizAnswered = false;

      // UI
      crumbEl.textContent = `Corsi ‚Ä¢ ${QUIZ_PACKS[state.currentCourseId].title} ‚Ä¢ Quiz`;
      navTo("quiz");
      renderQuestion();
    }

    function renderQuestion(){
      if (state.quizIndex >= state.quizQuestions.length){
        finishQuiz();
        return;
      }

      state.quizAnswered = false;

      const q = state.quizQuestions[state.quizIndex];
      qChip.textContent = `${QUIZ_PACKS[state.currentCourseId].icon} ${q.module}`;
      qCounter.textContent = `${state.quizIndex + 1} / ${state.quizQuestions.length}`;
      progressBar.style.width = `${(state.quizIndex / state.quizQuestions.length) * 100}%`;

      qText.textContent = q.q;
      optionsContainer.innerHTML = "";

      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "opt-btn";
        btn.textContent = opt;
        btn.onclick = () => handleAnswer(idx, btn);
        optionsContainer.appendChild(btn);
      });

      quizActions.classList.remove("visible");
    }

    async function handleAnswer(idx, btn){
      if (state.quizAnswered) return;
      state.quizAnswered = true;

      const q = state.quizQuestions[state.quizIndex];
      const buttons = Array.from(document.querySelectorAll(".opt-btn"));
      buttons.forEach(b => b.disabled = true);

      const isCorrect = idx === q.correctIndex;
      if (isCorrect){
        btn.classList.add("correct");
        state.quizCorrect++;
      } else {
        btn.classList.add("wrong");
        buttons[q.correctIndex].classList.add("correct");
      }

      // save progress per question (only if logged)
      if (state.isLogged && supa){
        try{
          await supa.rpc("record_question_attempt", {
            p_course_id: q.course_id,
            p_qid: q.qid,
            p_module: q.module,
            p_cat: q.cat,
            p_is_correct: isCorrect
          });
        }catch(e){
          console.warn("record_question_attempt error", e);
        }
      }

      quizActions.classList.add("visible");
    }

    function nextQuestion(){
      if (!vQuiz.classList.contains("active")) return;
      if (!state.quizAnswered){
        if(!confirm("Vuoi saltare questa domanda?")) return;
      }
      state.quizIndex++;
      renderQuestion();
    }

    function quitQuiz(){
      if(confirm("Vuoi uscire? Perderai i progressi di questa sessione.")){
        backToCourse();
      }
    }

    async function finishQuiz(){
      const pct = Math.round((state.quizCorrect / state.quizQuestions.length) * 100);
      finalScore.textContent = pct + "%";

      let msg = "Puoi fare di meglio.";
      if (pct >= 60) msg = "Buon risultato.";
      if (pct >= 80) msg = "Ottimo lavoro.";
      if (pct >= 90) msg = "Eccellente!";
      finalMsg.textContent = msg;

      progressBar.style.width = "100%";
      navTo("results");

      // save attempt
      if (state.isLogged && supa){
        try{
          const modules = [...new Set(state.quizQuestions.map(x => x.module))];
          await supa.from("quiz_attempts").insert({
            user_id: state.currentUser.id,
            course_id: state.currentCourseId,
            mode: state.mode,
            modules,
            total: state.quizQuestions.length,
            correct: state.quizCorrect,
            percent: pct
          });
        }catch(e){
          console.warn("quiz_attempts insert error", e);
        }
      }

      // update dashboard when returning
    }

    /***********************************************************************
     * Charts (HiDPI, Apple colors)
     **********************************************************************/
    function setupCanvas(canvas, cssHeight){
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width));
      const h = Math.max(1, Math.floor(cssHeight));

      canvas.style.height = h + "px";
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);

      return { ctx, w, h };
    }

    function drawGrid(ctx,w,h){
      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle = "rgba(0,0,0,0.08)";
      ctx.lineWidth = 1;
      for (let i=0;i<=4;i++){
        const y = (h/4)*i;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(w,y);
        ctx.stroke();
      }
    }

    function drawProgressChart(points){
      const canvas = document.getElementById("progressChart");
      if (!canvas) return;

      // normalize: allow [number] or [{v,t}] or [{percent,created_at}]
      const arr = (points || []).map(p => {
        if (typeof p === "number") return { v: p, t: null };
        return {
          v: (p && (p.v ?? p.percent ?? 0)) | 0,
          t: p?.t ?? p?.created_at ?? null
        };
      });

      const { ctx, w, h } = setupCanvas(canvas, 140);
      drawGrid(ctx,w,h);

      const primary = getComputedStyle(document.documentElement).getPropertyValue("--primary").trim() || "#0071e3";
      const sec = getComputedStyle(document.documentElement).getPropertyValue("--text-sec").trim() || "#86868b";
      const font = getComputedStyle(document.body).fontFamily;

      if (!arr.length){
        ctx.fillStyle = sec;
        ctx.font = "800 12px " + font;
        ctx.fillText("Fai un quiz (loggato) per riempire il grafico.", 10, h/2);
        return;
      }

      const padX=10, padY=14;
      const innerW = w - padX*2;
      const innerH = h - padY*2;

      const n = Math.min(arr.length, 30);
      const data = arr.slice(-n);
      const xs = data.map((_,i) => padX + (innerW * (n===1 ? 0 : i/(n-1))));
      const ys = data.map(d => padY + innerH * (1 - (Math.max(0, Math.min(100, d.v)) / 100)));

      // subtle fill
      const grad = ctx.createLinearGradient(0, padY, 0, padY + innerH);
      grad.addColorStop(0, "rgba(0,113,227,0.18)");
      grad.addColorStop(1, "rgba(0,113,227,0.02)");

      if (progressType === "bar"){
        const barW = innerW / n;
        for (let i=0;i<n;i++){
          const x = padX + i*barW + 3;
          const y = ys[i];
          const bw = Math.max(2, barW - 6);
          const bh = (padY + innerH) - y;

          ctx.fillStyle = "rgba(0,113,227,0.35)";
          ctx.beginPath();
          const r = 6;
          ctx.moveTo(x, y + r);
          ctx.arcTo(x, y, x + r, y, r);
          ctx.lineTo(x + bw - r, y);
          ctx.arcTo(x + bw, y, x + bw, y + r, r);
          ctx.lineTo(x + bw, y + bh);
          ctx.lineTo(x, y + bh);
          ctx.closePath();
          ctx.fill();
        }
      } else {
        // area
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(xs[0], padY + innerH);
        ctx.lineTo(xs[0], ys[0]);

        for (let i=1;i<n;i++){
          const xc = (xs[i-1] + xs[i]) / 2;
          const yc = (ys[i-1] + ys[i]) / 2;
          ctx.quadraticCurveTo(xs[i-1], ys[i-1], xc, yc);
        }
        ctx.lineTo(xs[n-1], ys[n-1]);
        ctx.lineTo(xs[n-1], padY + innerH);
        ctx.closePath();
        ctx.fill();

        // stroke
        ctx.strokeStyle = primary;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(xs[0], ys[0]);
        for (let i=1;i<n;i++){
          const xc = (xs[i-1] + xs[i]) / 2;
          const yc = (ys[i-1] + ys[i]) / 2;
          ctx.quadraticCurveTo(xs[i-1], ys[i-1], xc, yc);
        }
        ctx.lineTo(xs[n-1], ys[n-1]);
        ctx.stroke();

        // points
        for (let i=0;i<n;i++){
          ctx.fillStyle = "white";
          ctx.strokeStyle = primary;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(xs[i], ys[i], 3.2, 0, Math.PI*2);
          ctx.fill();
          ctx.stroke();
        }
      }

      // labels (first/last date if available)
      const t0 = data[0].t ? new Date(data[0].t) : null;
      const t1 = data[n-1].t ? new Date(data[n-1].t) : null;

      ctx.fillStyle = sec;
      ctx.font = "800 11px " + font;
      const lastVal = data[n-1].v;
      ctx.fillText(`${lastVal}%`, Math.max(8, xs[n-1]-18), Math.max(14, ys[n-1]-10));

      if (t0 && t1){
        const fmt = (d)=> String(d.getDate()).padStart(2,"0") + "/" + String(d.getMonth()+1).padStart(2,"0");
        ctx.fillText(fmt(t0), padX, h-6);
        const s = fmt(t1);
        const tw = ctx.measureText(s).width;
        ctx.fillText(s, w - padX - tw, h-6);
      }
    }

function drawModuleChart(labels, vals){
      const canvas = document.getElementById("moduleChart");
      if (!canvas) return;
      const { ctx, w, h } = setupCanvas(canvas, 180);
      drawGrid(ctx,w,h);

      const primary = getComputedStyle(document.documentElement).getPropertyValue("--primary").trim() || "#0071e3";
      if (!labels || labels.length === 0) return;

      const padX=12, padY=16;
      const innerW = w - padX*2;
      const innerH = h - padY*2;

      const n = labels.length;
      const barW = innerW / n;

      ctx.fillStyle = "rgba(0,113,227,0.70)";
      ctx.strokeStyle = primary;
      for (let i=0;i<n;i++){
        const v = vals[i] || 0;
        const barH = (v/100)*innerH;
        const x = padX + i*barW;
        const y = (h-padY) - barH;
        ctx.globalAlpha = 0.78;
        ctx.fillRect(x+2, y, Math.max(2, barW-4), barH);
        ctx.globalAlpha = 1;
      }
    }

    /***********************************************************************
     * Auth (Supabase)
     **********************************************************************/
    function toggleProfile(){
      // legacy: usato in vecchie versioni. Ora la login √® una pagina dedicata.
      openAuth("login");
    }

    function openAuth(tab){
      if (!supa){
        alert("Configura SUPABASE_URL e SUPABASE_ANON_KEY dentro l'HTML.");
        return;
      }

      // memorizza dove tornare dopo login
      const active = document.querySelector(".view.active")?.id || "view-dashboard";
      state.afterAuth = active.replace("view-","");

      authError.style.display = "none";

      // reset any success panel
      try{ hideAuthSuccess(); }catch(e){}
      authError.textContent = "";

      // mostra pagina account
      navTo("auth");

      if (tab === "signup"){
        authTitle.textContent = "Registrati";
        authSub.textContent = "Crea un account per salvare statistiche e progressi.";
        authSignup.classList.remove("hidden");
        authLogin.classList.add("hidden");
      } else {
        authTitle.textContent = "Accedi";
        authSub.textContent = "Email + password. Statistiche separate per corso.";
        authLogin.classList.remove("hidden");
        authSignup.classList.add("hidden");
      }

      // se gi√† loggato, mostra pannello logged-in
      if (state.isLogged){
        profileLoggedOut.classList.add("hidden");
        profileLoggedIn.classList.remove("hidden");
      }
      // scroll top
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function navBackFromAuth(){
      const dest = state.afterAuth || "dashboard";
      navTo(dest);
      if (dest === "course") refreshCourseDashboard();
      state.afterAuth = null;
    }

    function closeAuth(){
      navBackFromAuth();
    }

    function showAuthError(msg){
      authError.textContent = msg;
      authError.style.display = "block";
    }


    function prettyAuthError(err){
      const msg = (err && err.message) ? String(err.message) : String(err || "");
      const low = msg.toLowerCase();
      if (low.includes("invalid login credentials")) return "Email o password non corretti (oppure email non confermata).";
      if (low.includes("email not confirmed")) return "Devi confermare la email prima di accedere.";
      if (low.includes("already registered") || low.includes("user already registered")) return "Questa email √® gi√† registrata. Prova ad accedere.";
      if (low.includes("password should be at least")) return "Password troppo corta (min 8).";
      return msg || "Errore. Riprova.";
    }

    function hardClearSupabaseStorage(){
      try{
        const m = String(SUPABASE_URL || "").match(/^https?:\/\/([^.]+)\.supabase\.co/i);
        const ref = m ? m[1] : null;
        if (!ref) return;
        const prefix = `sb-${ref}-`;
        for (let i = localStorage.length - 1; i >= 0; i--){
          const k = localStorage.key(i);
          if (k && k.startsWith(prefix)) localStorage.removeItem(k);
        }
        for (let i = sessionStorage.length - 1; i >= 0; i--){
          const k = sessionStorage.key(i);
          if (k && k.startsWith(prefix)) sessionStorage.removeItem(k);
        }
      }catch(e){}
    }

    async function switchAccount(){
      try{ await logout({ silent: true }); }catch(e){}
      openAuth("login");
      try{
        document.getElementById("loginEmail").value = "";
        document.getElementById("loginPass").value = "";
        document.getElementById("loginEmail").focus();
      }catch(e){}
      toast("warn", "Cambia account", "Inserisci le credenziali del nuovo account.");
    }

    function showLoginSuccess(){
      const uname = state.profile?.username || (state.currentUser?.email ? state.currentUser.email.split("@")[0] : "utente");
      showAuthSuccess(
        `Bentornato, ${uname}`,
        "Accesso riuscito. I progressi sono attivi e sincronizzati.",
        "Vai ai corsi",
        ()=>{ hideAuthSuccess(); navTo("dashboard"); },
        "Cambia account",
        ()=>{ hideAuthSuccess(); switchAccount(); }
      );
      toast("success", "Accesso riuscito", "Bentornato.");
    }


    function baseRedirectUrl(){
      // GitHub Pages: origin + pathname directory, ensure ends with "/"
      let p = window.location.pathname;
      if (!p.endsWith("/")) p = p.substring(0, p.lastIndexOf("/") + 1);
      return window.location.origin + p;
    }

    
    async function signup(){
      const username = (document.getElementById("signupUser").value || "").trim();
      const email = (document.getElementById("signupEmail").value || "").trim();
      const pass = (document.getElementById("signupPass").value || "").trim();

      if (!username) return showAuthError("Inserisci uno username.");
      if (!email) return showAuthError("Inserisci una email.");
      if (pass.length < 8) return showAuthError("Password troppo corta (min 8).");

      try{
        const { error } = await supa.auth.signUp({
          email,
          password: pass,
          options: {
            data: { username },
            emailRedirectTo: baseRedirectUrl()
          }
        });

        if (error) return showAuthError(prettyAuthError(error));

        // keep user in-app and show premium success panel (no browser alert)
        try{ document.getElementById("signupPass").value = ""; }catch(e){}
        showSignupSuccess();
      }catch(e){
        console.warn(e);
        showAuthError("Errore durante la registrazione. Riprova.");
      }
    }

    
    async function login(){
      const email = (document.getElementById("loginEmail").value || "").trim();
      const pass = (document.getElementById("loginPass").value || "").trim();

      if (!email || !pass) return showAuthError("Inserisci email e password.");

      // If user is already logged-in with a different email, suggest switching account
      if (state.isLogged && state.currentUser?.email && state.currentUser.email.toLowerCase() !== email.toLowerCase()){
        return showAuthError(`Sei gi√† loggato come ${state.currentUser.email}. Premi ‚ÄúCambia account‚Äù per entrare con un altro profilo.`);
      }

      try{
        const { error } = await supa.auth.signInWithPassword({ email, password: pass });
        if (error) return showAuthError(prettyAuthError(error));

        await refreshAuthState();
        try{ document.getElementById("loginPass").value = ""; }catch(e){}
        showLoginSuccess();
      }catch(e){
        console.warn(e);
        showAuthError("Errore durante il login. Riprova.");
      }
    }

    
    async function logout(opts={}){
      if (!supa) return;

      const silent = !!opts.silent;

      // Force-reset UI (prevents "stuck quiz" / missing next button)
      try{ forceResetSessionUI(); }catch(e){}

      // Normal sign-out
      try{
        const { error } = await supa.auth.signOut({ scope: "local" });
        if (error) console.warn("signOut error", error);
      }catch(e){
        console.warn("signOut exception", e);
      }

      // Hard cleanup (fixes rare cases where the session looks still active)
      hardClearSupabaseStorage();

      // Force UI state to logged-out (don‚Äôt rely on timing of onAuthStateChange)
      state.isLogged = false;
      state.currentUser = null;
      state.profile = null;
      setAuthUI(null);

      renderCourses();
      if (vCourse.classList.contains("active")) refreshCourseDashboard();

      if (!silent){
        toast("success", "Sei uscito", "Sessione chiusa correttamente. Ora sei in modalit√† ospite.");
      }

      if (opts.openLogin) openAuth("login");
    }

    async function refreshAuthState(){
      const { data } = await supa.auth.getSession();
      const user = data.session?.user || null;
      state.currentUser = user;
      state.isLogged = !!user;

      if (user){
        // load profile
        const { data: prof } = await supa.from("profiles").select("username").eq("id", user.id).maybeSingle();
        state.profile = prof || null;
      } else {
        state.profile = null;
      }

      setAuthUI(user);
      renderCourses();
      if (vCourse.classList.contains("active")) refreshCourseDashboard();

    }

    function setAuthUI(user){
      if (user){
        const uname = state.profile?.username || (user.email ? user.email.split("@")[0] : "Utente");

        if (chipAuth) chipAuth.textContent = "üîì Loggato";
        if (userDisplay) userDisplay.textContent = `${uname} ‚Ä¢ ${user.email || ""}`;
        if (userDisplayDash) userDisplayDash.textContent = `${uname} ‚Ä¢ ${user.email || ""}`;

        if (profileLoggedOut) profileLoggedOut.classList.add("hidden");
        if (profileLoggedIn) profileLoggedIn.classList.remove("hidden");

        if (dashLoggedOut) dashLoggedOut.classList.add("hidden");
        if (dashLoggedIn) dashLoggedIn.classList.remove("hidden");
      } else {
        if (chipAuth) chipAuth.textContent = "üîí Ospite";
        if (userDisplay) userDisplay.textContent = "Ospite (login opzionale)";
        if (userDisplayDash) userDisplayDash.textContent = "Ospite (login opzionale)";

        if (profileLoggedOut) profileLoggedOut.classList.remove("hidden");
        if (profileLoggedIn) profileLoggedIn.classList.add("hidden");

        if (dashLoggedOut) dashLoggedOut.classList.remove("hidden");
        if (dashLoggedIn) dashLoggedIn.classList.add("hidden");
      }
    }


    /***********************************************************************
     * In-app feedback (toasts + auth success)
     **********************************************************************/
    const toastStack = document.getElementById("toast-stack");
    const authSuccessBox = document.getElementById("auth-success");
    const authSuccessTitle = document.getElementById("auth-success-title");
    const authSuccessSub = document.getElementById("auth-success-sub");
    const authSuccessPrimaryBtn = document.getElementById("auth-success-primary");
    const authSuccessSecondaryBtn = document.getElementById("auth-success-secondary");

    let __authSuccessPrimaryAction = null;
    let __authSuccessSecondaryAction = null;

    function toast(kind, title, message, actions=[]){
      if (!toastStack) return;
      const el = document.createElement("div");
      el.className = `toast ${kind||""}`.trim();
      el.innerHTML = `
        <div style="padding-left:6px;">
          <h4>${escapeHtml(title||"Info")}</h4>
          <p>${escapeHtml(message||"")}</p>
          <div class="t-actions"></div>
        </div>
        <button class="t-x" aria-label="Chiudi">‚úï</button>
      `;
      const actionsWrap = el.querySelector(".t-actions");
      (actions||[]).slice(0,3).forEach(a=>{
        const b = document.createElement("button");
        b.className = "t-btn" + (a.primary ? " primary" : "");
        b.textContent = a.label || "Ok";
        b.onclick = () => { try{ a.onClick && a.onClick(); }catch(e){}; remove(); };
        actionsWrap.appendChild(b);
      });

      const remove = () => {
        el.style.transition = "opacity .18s ease, transform .18s ease";
        el.style.opacity = "0";
        el.style.transform = "translateY(-6px)";
        setTimeout(()=> el.remove(), 180);
      };

      el.querySelector(".t-x").onclick = remove;
      toastStack.appendChild(el);

      // auto-dismiss
      setTimeout(remove, 3800);
    }

    function showAuthSuccess(title, sub, primaryLabel, primaryAction, secondaryLabel, secondaryAction){
      if (!authSuccessBox) return;
      authSuccessTitle.textContent = title || "Operazione completata";
      authSuccessSub.textContent = sub || "";
      authSuccessBox.classList.remove("hidden");

      __authSuccessPrimaryAction = primaryAction || null;
      __authSuccessSecondaryAction = secondaryAction || null;

      authSuccessPrimaryBtn.textContent = primaryLabel || "Vai ai corsi";
      authSuccessSecondaryBtn.textContent = secondaryLabel || "Accedi";

      // Hide error if visible
      authError.style.display = "none";
      authError.textContent = "";

      // scroll into view
      authSuccessBox.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function hideAuthSuccess(){
      if (!authSuccessBox) return;
      authSuccessBox.classList.add("hidden");
      __authSuccessPrimaryAction = null;
      __authSuccessSecondaryAction = null;
    }

    function authSuccessPrimary(){
      if (__authSuccessPrimaryAction) return __authSuccessPrimaryAction();
      navTo("dashboard");
    }
    function authSuccessSecondary(){
      if (__authSuccessSecondaryAction) return __authSuccessSecondaryAction();
      openAuth("login");
    }

    function showSignupSuccess(){
      // If email confirmation is enabled, session might be null.
      // We'll detect session via current state after refresh.
      (async ()=>{
        await refreshAuthState();
        if (state.isLogged){
          const uname = state.profile?.username || (state.currentUser?.email ? state.currentUser.email.split("@")[0] : "utente");
          showAuthSuccess(
            `Benvenuto, ${uname}`,
            "Account creato con successo. I progressi verranno salvati automaticamente.",
            "Vai ai corsi",
            ()=>{ hideAuthSuccess(); navTo("dashboard"); },
            "Cambia account",
            ()=>{ hideAuthSuccess(); switchAccount(); }
          );
          toast("success","Registrazione completata","Sei gi√† loggato: puoi iniziare subito.");
        } else {
          showAuthSuccess(
            "Registrazione inviata",
            "Se hai la conferma email attiva, apri il link ricevuto e poi torna qui per accedere.",
            "Torna ai corsi",
            ()=>{ hideAuthSuccess(); navTo("dashboard"); },
            "Vai al login",
            ()=>{ hideAuthSuccess(); openAuth("login"); }
          );
          toast("success","Registrazione completata","Controlla la tua email se la conferma √® attiva.");
        }
      })();
    }

    function forceResetSessionUI(){
      // Reset quiz state (prevents UI inconsistencies after logout)
      state.mode = null;
      state.quizQuestions = [];
      state.quizIndex = 0;
      state.quizCorrect = 0;
      state.quizAnswered = false;

      // reset current course selection (optional but safer)
      state.selectedModules.clear();

      // UI: hide floating quiz bar, ensure we are not stuck in quiz view
      try{ quizActions.classList.remove("visible"); }catch(e){}
      try{ courseActions.classList.remove("visible"); }catch(e){}

      // If currently in quiz view, jump out without confirm
      try{
        if (vQuiz && vQuiz.classList.contains("active")){
          navTo("dashboard");
          state.currentCourseId = null;
          crumbEl.textContent = "Corsi";
        }
      }catch(e){}

      // also, clear any transient DOM that could hide buttons
      try{ optionsContainer.innerHTML = ""; }catch(e){}
      try{ qText.textContent = ""; }catch(e){}
      try{ qCounter.textContent = ""; }catch(e){}
      try{ progressBar.style.width = "0%"; }catch(e){}
    }


/***********************************************************************
     * Utils
     **********************************************************************/
    function shuffle(arr){
      const a = [...arr];
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function trim(s, n){
      if (!s) return "";
      return s.length > n ? s.slice(0,n-1) + "‚Ä¶" : s;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s]));
    }

    function makeQid(courseId, moduleName, qText){
      const base = `${courseId}||${moduleName}||${qText}`.toLowerCase();
      const h = fnv1a(base);
      return `${courseId}:${h}`;
    }

    function fnv1a(str){
      let hash = 0x811c9dc5;
      for (let i=0;i<str.length;i++){
        hash ^= str.charCodeAt(i);
        hash = (hash + ((hash<<1) + (hash<<4) + (hash<<7) + (hash<<8) + (hash<<24))) >>> 0;
      }
      return hash.toString(16).padStart(8,"0");
    }
  </script>

  <!-- Toasts (premium, in-app feedback) -->
  <div class="toast-stack" id="toast-stack" aria-live="polite" aria-atomic="true"></div>

</body>
</html>
